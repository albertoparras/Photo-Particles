var AEROTWIST=AEROTWIST||{};AEROTWIST.PhotoParticles=new function(){var u,y,D,n,e,m,O,g,o,k,H,K,E=[],N=0,p=false,q=false,w=false,i=$("#container"),z=$("#gui"),c=0.01,L=0,s=1,f=i.width()-15,B=i.height()-15,F=7,M=1,J=10000,t=5,v=20,r=Math.max(f,B);this.init=function(){n=L;m=document.createElement("canvas");m.width=600;m.height=600;O=m.getContext("2d");u=new THREE.Camera(45,f/B,M,J);y=new THREE.Scene();D=new THREE.WebGLRenderer();D.setSize(f,B);i.append(D.domElement);d();b();x();C()};function x(){var P=i[0];P.addEventListener("dragover",j,false);P.addEventListener("dragenter",j,false);P.addEventListener("dragexit",j,false);P.addEventListener("drop",a,false);$("#hold-particles-on").click(callbacks.holdAtOriginOn);$("#hold-particles-off").click(callbacks.holdAtOriginOff);$("#hold-particles-off").trigger("click");$("#camera-orbit-on").click(callbacks.orbitCameraOn);$("#camera-orbit-off").click(callbacks.orbitCameraOff);$("#camera-orbit-on").trigger("click");$("#mode-attract").click(callbacks.modeAttract);$("#mode-repel").click(callbacks.modeRepel);$("#mode-attract").trigger("click");$("#strength-1").click(callbacks.strength1);$("#strength-2").click(callbacks.strength2);$("#strength-3").click(callbacks.strength3);$("#strength-4").click(callbacks.strength4);$("#strength-5").click(callbacks.strength5);$("#strength-3").trigger("click");$("#bounce-particles-on").click(callbacks.bounceParticlesOn);$("#bounce-particles-off").click(callbacks.bounceParticlesOff);$("#bounce-particles-off").trigger("click");$("#density-low").click(callbacks.densityLow);$("#density-medium").click(callbacks.densityMedium);$("#density-high").click(callbacks.densityHigh);$("#density-low").trigger("click");$(window).resize(callbacks.windowResize)}function a(Q){Q.stopPropagation();Q.preventDefault();var P=Q.dataTransfer.files;if(P.length){h(P[0])}return false}function h(Q){var P=new FileReader();P.onloadend=I;P.readAsDataURL(Q)}function I(P){if(e){l()}if(P.target.result.match(/^data:image/)){i.addClass("live");z.addClass("live");e=document.createElement("img");e.src=P.target.result;setTimeout(function(){G()},100)}else{alert("Umm, images only? ... Yeah")}}function j(P){if(P.preventDefault){P.preventDefault()}return false}function d(){pointLight=new THREE.PointLight(16777215);pointLight.position.x=300;pointLight.position.y=300;pointLight.position.z=600;y.addLight(pointLight);directionalLight=new THREE.DirectionalLight(16777215);directionalLight.position.x=-0.5;directionalLight.position.y=-1;directionalLight.position.z=-0.5;directionalLight.position.normalize();directionalLight.intensity=0.6;y.addLight(directionalLight)}function b(){var P=new THREE.MeshLambertMaterial({color:13369344}),R=new THREE.MeshLambertMaterial({color:52224}),Q=new THREE.MeshLambertMaterial({color:204});g=new THREE.Mesh(new Sphere(20,16,16),P);g.position.y=120;g.position.z=-160;g.mass=t;g.boundRadiusSquared=g.boundRadius*g.boundRadius;o=new THREE.Mesh(new Sphere(20,16,16),R);o.position.z=160;o.position.y=-120;o.position.x=-160;o.mass=t;o.boundRadiusSquared=o.boundRadius*o.boundRadius;k=new THREE.Mesh(new Sphere(20,16,16),Q);k.position.z=160;k.position.y=-120;k.position.x=160;k.mass=t;k.boundRadiusSquared=k.boundRadius*k.boundRadius;y.addChild(g);y.addChild(o);y.addChild(k)}function l(){y.removeChild(K);K=null;O.clearRect(0,0,600,600)}function G(){var Z=1/Math.max(e.width/600,e.height/600);var V=e.width*Z;var X=e.height*Z;O.drawImage(e,0,0,e.width,e.height,(600-V)*0.5,(600-X)*0.5,V,X);var Y=new THREE.ParticleBasicMaterial({blending:THREE.BillboardBlending,map:ImageUtils.loadTexture("images/particle.png"),size:F*1.5,opacity:1,vertexColors:true,sizeAttenuation:true});var ab=new THREE.Geometry();var T=O.getImageData(0,0,m.width,m.height);var S=F*4;var ac=0,aa=0;for(ac=0;ac<m.width*4;ac+=S){for(aa=m.height;aa>=0;aa-=F){var Q=((aa*m.width*4)+ac);if(T.data[Q+3]>0){var ad=(T.data[Q]<<16)+(T.data[Q+1]<<8)+T.data[Q+2];var U=new THREE.Color(ad);var R=new THREE.Vector3(-300+ac/4,240-aa,0);ab.vertices.push(new THREE.Vertex(R));ab.colors.push(U)}}}K=new THREE.ParticleSystem(ab,Y);K.sortParticles=true;E=K.geometry.vertices;H=K.geometry.colors;var P=E.length;while(P--){var W=E[P];W.velocity=new THREE.Vector3();W.mass=5;W.origPos=W.position.clone()}T=null;y.addObject(K)}function C(){var P=E.length;while(P--){var U=E[P];if(p){U.velocity=new THREE.Vector3();U.position.x+=(U.origPos.x-U.position.x)*0.2;U.position.y+=(U.origPos.y-U.position.y)*0.2;U.position.z+=(U.origPos.z-U.position.z)*0.2}else{var R=H[P];var X=[R.r,R.g,R.b];for(var T=0;T<X.length;T++){if(X[T]>0){var V=T==0?g:T==1?o:k;var W=U.position.distanceToSquared(V.position),Q=((U.mass*V.mass)/W)*X[T]*v,S=(new THREE.Vector3()).sub(V.position,U.position).normalize().multiplyScalar(Q);if(n==L){if(W>V.boundRadiusSquared){U.velocity.addSelf(S)}else{if(w){U.velocity.negate()}else{U.velocity=new THREE.Vector3()}}}else{U.velocity.subSelf(S)}U.position.addSelf(U.velocity)}}}}if(q){u.position.x=Math.sin(N)*r;u.position.y=Math.sin(N)*300;u.position.z=Math.cos(N)*r;N+=c}requestAnimationFrame(A)}function A(){if(e){D.render(y,u)}C()}callbacks={holdAtOriginOn:function(){p=true;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},holdAtOriginOff:function(){p=false;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},orbitCameraOn:function(){q=true;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},orbitCameraOff:function(){q=false;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},modeAttract:function(){n=L;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},modeRepel:function(){n=s;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},bounceParticlesOn:function(){w=true;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},bounceParticlesOff:function(){w=false;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},densityLow:function(){F=7;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");if(e){l();G()}return false},densityMedium:function(){F=5;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");if(e){l();G()}return false},densityHigh:function(){F=3;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");if(e){l();G()}return false},strength1:function(){v=1;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},strength2:function(){v=10;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},strength3:function(){v=20;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},strength4:function(){v=35;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},strength5:function(){v=50;$(this).removeClass("disabled");$(this).siblings("a").addClass("disabled");return false},windowResize:function(){f=i.width()-15,B=i.height()-15,u.aspect=f/B,D.setSize(f,B);u.updateProjectionMatrix()}}};$(document).ready(function(){if(Modernizr.webgl){AEROTWIST.PhotoParticles.init()}});